{"clear_ods": {"clear_ods_payment": "DELETE FROM pdmitry.ods_payment_final WHERE EXTRACT(YEAR FROM pay_date::DATE) = {{ execution_date.year }}", "clear_ods_mdm": "DELETE FROM pdmitry.ods_mdm_user_final WHERE EXTRACT(YEAR FROM registered_at::DATE) = {{ execution_date.year }}", "clear_ods_payment_hashed": "DELETE FROM pdmitry.ods_payment_hashed_final WHERE EXTRACT(YEAR FROM pay_date::DATE) = {{ execution_date.year }}", "clear_ods_mdm_gashed": "DELETE FROM pdmitry.ods_mdm_hashed_final WHERE EXTRACT(YEAR FROM registered_at::DATE) = {{ execution_date.year }}"}, "fill_ods": {"fill_ods_payment": "INSERT INTO pdmitry.ods_payment_final\n        SELECT * FROM pdmitry.stg_payment_final \n        WHERE EXTRACT(YEAR FROM pay_date::DATE) = {{ execution_date.year }}", "fill_ods_mdm": "INSERT INTO pdmitry.ods_mdm_user_final\n        SELECT * FROM mdm.user \n        WHERE EXTRACT(YEAR FROM registered_at::DATE) = {{ execution_date.year }}"}, "fill_hashed": {"fill_ods_payment_hashed": "INSERT INTO pdmitry.ods_payment_hashed_final\n        SELECT *, '{{ execution_date }}'::TIMESTAMP AS LOAD_DATE FROM pdmitry.ods_view_payment_final \n        WHERE EXTRACT(YEAR FROM pay_date::DATE) = {{ execution_date.year }}", "fill_ods_mdm_hashed": "INSERT INTO pdmitry.ods_mdm_hashed_final\n        SELECT *, '{{ execution_date }}'::TIMESTAMP AS LOAD_DATE FROM pdmitry.ods_view_mdm_final \n        WHERE EXTRACT(YEAR FROM registered_at::DATE) = {{ execution_date.year }}"}, "hub": {"user": "INSERT INTO pdmitry.dds_hub_user_final (user_pk, user_key, load_date, record_source)\n    SELECT user_pk, user_key, load_date, record_source\n    FROM pdmitry.view_hub_user_etl_final", "billing_period": "insert into pdmitry.dds_hub_billing_period_final (BILLING_PERIOD_PK, BILLING_PERIOD_KEY, LOAD_DATE, RECORD_SOURCE)\n    SELECT BILLING_PERIOD_PK, BILLING_PERIOD_KEY, LOAD_DATE, RECORD_SOURCE\n    FROM pdmitry.view_hub_billing_period_etl_final", "account": "insert into pdmitry.dds_hub_account_final (ACCOUNT_PK, ACCOUNT_KEY, LOAD_DATE, RECORD_SOURCE)\n    SELECT ACCOUNT_PK, ACCOUNT_KEY, LOAD_DATE, RECORD_SOURCE\n    FROM pdmitry.view_hub_account_etl_final"}, "link": {"payment": "insert into pdmitry.dds_link_payment_final (PAY_PK, USER_PK, ACCOUNT_PK, BILLING_PERIOD_PK, LOAD_DATE, RECORD_SOURCE)\n    SELECT PAY_PK, USER_PK, ACCOUNT_PK, BILLING_PERIOD_PK, LOAD_DATE, RECORD_SOURCE\n    FROM pdmitry.view_link_payment_etl_final"}, "sat": {"user": "insert into pdmitry.dds_sat_user_final (user_pk, user_hashdif, phone, effective_from, load_date, record_source)\n    with source_data as (\n    select a.USER_PK, a.USER_HASHDIF, a.phone, a.EFFECTIVE_FROM, a.LOAD_DATE, a.RECORD_SOURCE from pdmitry.ods_payment_hashed_final as a\n    WHERE EXTRACT(YEAR FROM a.pay_date::DATE) = {{ execution_date.year }}\n    ),\n    update_records as (\n    select a.USER_PK, a.USER_HASHDIF, a.phone, a.EFFECTIVE_FROM, a.LOAD_DATE, a.RECORD_SOURCE from pdmitry.dds_sat_user_final as a\n    join source_data as b on a.USER_PK = b.USER_PK AND a.LOAD_DATE <= (SELECT max(LOAD_DATE) from source_data)\n    ),\n    latest_records as (\n     select * from (\n                   select c.USER_PK, c.USER_HASHDIF, c.LOAD_DATE,\n                   CASE WHEN RANK() OVER (PARTITION BY c.USER_PK ORDER BY c.LOAD_DATE DESC) = 1\n                   THEN 'Y' ELSE 'N' END AS latest\n            FROM update_records as c\n        ) as s\n        WHERE latest = 'Y'\n        ),\n    records_to_insert as (\n     select distinct e.USER_PK, e.USER_HASHDIF, e.phone, e.EFFECTIVE_FROM, e.LOAD_DATE, e.RECORD_SOURCE\n     from source_data as e\n     left join latest_records on latest_records.USER_HASHDIF=e.USER_HASHDIF and latest_records.USER_PK=e.USER_PK\n     where latest_records.USER_HASHDIF is null\n      )\n select * from records_to_insert", "link_payment": "insert into pdmitry.dds_sat_link_payment_final (PAY_PK, pay_doc_num, pay_doc_type, PAYMENT_HASHDIF, pay_date, sum, EFFECTIVE_FROM, LOAD_DATE, RECORD_SOURCE)\n    with source_data as (\n    select a.PAY_PK, a.pay_doc_num, a.pay_doc_type, a.PAYMENT_HASHDIF, a.pay_date, a.sum, a.EFFECTIVE_FROM, a.LOAD_DATE, a.RECORD_SOURCE\n    from pdmitry.ods_payment_hashed_final as a\n    WHERE EXTRACT(YEAR FROM a.pay_date::DATE) = {{ execution_date.year }}\n    ),\n     update_records as (\n        select a.PAY_PK, a.PAYMENT_HASHDIF, a.pay_date, a.sum, a.EFFECTIVE_FROM, a.LOAD_DATE, a.RECORD_SOURCE from pdmitry.dds_sat_link_payment_final as a\n        join source_data as b on a.PAY_PK = b.PAY_PK AND a.LOAD_DATE <= (SELECT max(LOAD_DATE) from source_data)\n     ),\n     latest_records as (\n         select * from (\n                       select c.PAY_PK, c.PAYMENT_HASHDIF, c.LOAD_DATE,\n                       CASE WHEN RANK() over (partition by c.PAY_PK order by c.LOAD_DATE DESC) = 1\n                       THEN 'Y' ELSE 'N' END AS latest\n                FROM update_records as c\n            ) as s\n            WHERE latest = 'Y'\n            ),\n     records_to_insert as (\n         select distinct e.PAY_PK, e.pay_doc_num, e.pay_doc_type, e.PAYMENT_HASHDIF, e.pay_date, e.sum, e.EFFECTIVE_FROM, e.LOAD_DATE, e.RECORD_SOURCE\n         from source_data as e\n         left join latest_records on latest_records.PAYMENT_HASHDIF=e.PAYMENT_HASHDIF and latest_records.PAY_PK=e.PAY_PK\n         where latest_records.PAYMENT_HASHDIF is null\n          )\n     select * from records_to_insert", "mdm": "insert into pdmitry.dds_sat_mdm_final (USER_PK, legal_type, district, registered_at, billing_mode, is_vip, mdm_hashdif, effective_from, LOAD_DATE, RECORD_SOURCE)\n    with source_data as (\n    select a.USER_PK, a.legal_type, a.district, a.registered_at, a.billing_mode, a.is_vip, a.mdm_hashdif, a.effective_from, a.LOAD_DATE, a.RECORD_SOURCE from pdmitry.ods_mdm_hashed_final as a\n    WHERE EXTRACT(YEAR FROM a.effective_from) = {{ execution_date.year }}\n    ),\n     update_records as (\n        select a.USER_PK, a.legal_type, a.district, a.registered_at, a.billing_mode, a.is_vip, a.mdm_hashdif, a.effective_from, a.LOAD_DATE, a.RECORD_SOURCE from pdmitry.dds_sat_mdm_final as a\n        join source_data as b on a.USER_PK = b.USER_PK AND a.LOAD_DATE <= (SELECT max(LOAD_DATE) from source_data)\n     ),\n     latest_records as (\n         select * from (\n                       select c.USER_PK, c.MDM_HASHDIF, c.LOAD_DATE,\n                       CASE WHEN RANK() over (partition by c.USER_PK order by c.LOAD_DATE DESC) = 1\n                       THEN 'Y' ELSE 'N' END AS latest\n                FROM update_records as c\n            ) as s\n            WHERE latest = 'Y'\n            ),\n     records_to_insert as (\n         select distinct e.USER_PK, e.legal_type, e.district, e.registered_at, e.billing_mode, e.is_vip, e.mdm_hashdif,e.effective_from, e.LOAD_DATE, e.RECORD_SOURCE\n         from source_data as e\n         left join latest_records on latest_records.MDM_HASHDIF=e.MDM_HASHDIF and latest_records.USER_PK=e.USER_PK\n         where latest_records.MDM_HASHDIF is null\n          )\n     select * from records_to_insert"}}